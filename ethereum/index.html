<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Star Notary</title>
        <link rel="stylesheet" type="text/css" href="style.css">

        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    </head>

    <body>
        <div class="container">
            <h1>Claim your star</h1>

            <div class="row">
                <label class="bold">Star Name:</label>
                <input id="star-name-claim" value="Betelgeuse"></input>
            </div>

            <div class="row">
                <label class="bold">Star RA:</label>
                <input id="star-ra-claim" value="5h 55m 10s"></input>
            </div>

            <div class="row">
                <label class="bold">Star Declination:</label>
                <input id="star-dec-claim" value="+7° 24′ 26″"></input>
            </div>

            <div class="row">
                <label class="bold">Star Magnitude:</label>
                <input id="star-mag-claim" value="−5.85"></input>
            </div>

            <div class="row">
                <label class="bold">Star Constellation:</label>
                <input id="star-con-claim" value="Orion"></input>
            </div>

            <div class="row">
                <label class="bold">Tell your story:</label>
                <input id="star-story-claim" value="Did you know: Betelgeuse emits almost 7,500 times as much energy as the Sun"></input>
            </div>
            <div class="row" id="message-claim"></div>
            <button id="claim-button" onclick="claimStar()">Claim Star</button>
        </div>
        <div class="container">
            <h1>Look Up a Star</h1>
            <div class="row">
                <label class="bold">Token:</label>
                <input id="star-token"></input>
            </div>
            <div class="row">
                <label class="bold">Star Name:</label>
                <label id="star-name"></label>
            </div>
            <div class="row">
                <label class="bold">Star Owner:</label>
                <label id="star-owner"></label>
            </div>
            <div class="row">
                <label class="bold">Star is for Sale:</label>
                <label id="star-price"></label>
            </div>
            <div class="row" id="message-lookup"></div>
            <button id="lookup-button" onclick="lookUpStar()">Look Up</button>
        </div>

        <script>    
         
            if(typeof web3 != 'undefined') { 
                console.log('Metamask was detected')
                web3 = new Web3(web3.currentProvider) // what Metamask injected 
            } else {
                // Instantiate and set Ganache as your provider
                web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }

            console.log(web3)

            // The default (top) wallet account from a list of test accounts 
            web3.eth.defaultAccount = web3.eth.accounts[0];

            // The interface definition for your smart contract (the ABI) 
            var StarNotary = web3.eth.contract(
                [
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "interfaceId",
                    "type": "bytes4"
                  }
                ],
                "name": "supportsInterface",
                "outputs": [
                  {
                    "name": "",
                    "type": "bool"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "getApproved",
                "outputs": [
                  {
                    "name": "",
                    "type": "address"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "to",
                    "type": "address"
                  },
                  {
                    "name": "tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "approve",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "from",
                    "type": "address"
                  },
                  {
                    "name": "to",
                    "type": "address"
                  },
                  {
                    "name": "tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "transferFrom",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "from",
                    "type": "address"
                  },
                  {
                    "name": "to",
                    "type": "address"
                  },
                  {
                    "name": "tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "ownerOf",
                "outputs": [
                  {
                    "name": "",
                    "type": "address"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "owner",
                    "type": "address"
                  }
                ],
                "name": "balanceOf",
                "outputs": [
                  {
                    "name": "",
                    "type": "uint256"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "to",
                    "type": "address"
                  },
                  {
                    "name": "approved",
                    "type": "bool"
                  }
                ],
                "name": "setApprovalForAll",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "from",
                    "type": "address"
                  },
                  {
                    "name": "to",
                    "type": "address"
                  },
                  {
                    "name": "tokenId",
                    "type": "uint256"
                  },
                  {
                    "name": "_data",
                    "type": "bytes"
                  }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "owner",
                    "type": "address"
                  },
                  {
                    "name": "operator",
                    "type": "address"
                  }
                ],
                "name": "isApprovedForAll",
                "outputs": [
                  {
                    "name": "",
                    "type": "bool"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "anonymous": false,
                "inputs": [
                  {
                    "indexed": true,
                    "name": "from",
                    "type": "address"
                  },
                  {
                    "indexed": true,
                    "name": "to",
                    "type": "address"
                  },
                  {
                    "indexed": true,
                    "name": "tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "Transfer",
                "type": "event"
              },
              {
                "anonymous": false,
                "inputs": [
                  {
                    "indexed": true,
                    "name": "owner",
                    "type": "address"
                  },
                  {
                    "indexed": true,
                    "name": "approved",
                    "type": "address"
                  },
                  {
                    "indexed": true,
                    "name": "tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "Approval",
                "type": "event"
              },
              {
                "anonymous": false,
                "inputs": [
                  {
                    "indexed": true,
                    "name": "owner",
                    "type": "address"
                  },
                  {
                    "indexed": true,
                    "name": "operator",
                    "type": "address"
                  },
                  {
                    "indexed": false,
                    "name": "approved",
                    "type": "bool"
                  }
                ],
                "name": "ApprovalForAll",
                "type": "event"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "_name",
                    "type": "string"
                  },
                  {
                    "name": "_ra",
                    "type": "string"
                  },
                  {
                    "name": "_dec",
                    "type": "string"
                  },
                  {
                    "name": "_mag",
                    "type": "string"
                  },
                  {
                    "name": "_con",
                    "type": "string"
                  },
                  {
                    "name": "_story",
                    "type": "string"
                  },
                  {
                    "name": "_tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "createStar",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "_tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "mint",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "_ra",
                    "type": "string"
                  },
                  {
                    "name": "_dec",
                    "type": "string"
                  }
                ],
                "name": "checkIfStarExist",
                "outputs": [
                  {
                    "name": "",
                    "type": "bool"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "_tokenId",
                    "type": "uint256"
                  },
                  {
                    "name": "_price",
                    "type": "uint256"
                  }
                ],
                "name": "putStarUpForSale",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "_tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "starsForSale",
                "outputs": [
                  {
                    "name": "",
                    "type": "uint256"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "constant": false,
                "inputs": [
                  {
                    "name": "_tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "buyStar",
                "outputs": [],
                "payable": true,
                "stateMutability": "payable",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "_tokenId",
                    "type": "uint256"
                  }
                ],
                "name": "tokenIdToStarInfo",
                "outputs": [
                  {
                    "name": "",
                    "type": "string"
                  },
                  {
                    "name": "",
                    "type": "string"
                  },
                  {
                    "name": "",
                    "type": "string"
                  },
                  {
                    "name": "",
                    "type": "string"
                  },
                  {
                    "name": "",
                    "type": "string"
                  }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
              },
              {
                "constant": true,
                "inputs": [
                  {
                    "name": "_ra",
                    "type": "string"
                  },
                  {
                    "name": "_dec",
                    "type": "string"
                  },
                  {
                    "name": "_mag",
                    "type": "string"
                  },
                  {
                    "name": "_con",
                    "type": "string"
                  }
                ],
                "name": "token",
                "outputs": [
                  {
                    "name": "",
                    "type": "uint256"
                  }
                ],
                "payable": false,
                "stateMutability": "pure",
                "type": "function"
              }

              ]
            );
            // Grab the contract at specified deployed address with the interface defined by the ABI
            var starNotary = StarNotary.at('0x3df7e942bfd36d37788973dbbecde04af8038d8c');
            // localhost with mnemonic from truffle.js
            //var starNotary = StarNotary.at('0x93ccb7bd19439bc185bb6c7a9a6496c327e13e8e');
            
            function claimStar() {
              setMessage('claim')
              let star = {
                name : document.getElementById('star-name-claim').value,
                story : document.getElementById('star-story-claim').value,
                ra : document.getElementById('star-ra-claim').value,
                dec : document.getElementById('star-dec-claim').value,
                mag : document.getElementById('star-mag-claim').value,
                con : document.getElementById('star-con-claim').value
              }
              web3.eth.getAccounts(async function(error, accounts) {
                  if (error) { 
                      console.log(error)
                      return
                  }
                  var account = accounts[0]
                  console.log(`Creating star ${star}`)
                  starNotary.token(star.ra, star.dec, star.mag, star.con, function(error, result) {
                    if (error) {
                      console.error(error)
                      setMessage('claim', error, 'red')
                    } else {
                      let token = result
                      console.log(`with token ${token}`)
                      starNotary.createStar(star.name,star.ra,star.dec, star.mag, star.con, star.story, token, {from: account}, async function(error, result) {
                          if (error) {
                              console.error(error)
                              setMessage('claim', error, 'red')
                          } else {
                              console.log(result)                                   
                              setMessage('claim', `Your star was claimed. Remember the token: ${token}`, 'green')
                          } 
                      })                      
                    }
                  })
              })
            }

            function lookUpStar() {
              setMessage('lookup')
              web3.eth.getAccounts(function(error, accounts) {
                if (error) { 
                    console.log(error)
                    setMessage('lookup', error, 'red')
                    return
                }
                const owner = accounts[0]
                let token = document.getElementById('star-token').value
                if (!token) {
                  setMessage('lookup', 'Please enter a valid star token', 'red')
                  return
                }
                // Get and display star name
                starNotary.tokenIdToStarInfo(token, function(error, result) {
                    if (!error) {
                        document.getElementById('star-name').innerText = result[0]
                    } else { 
                        console.log(error);
                        setMessage('lookup', error, 'red')
                    }
                })
                // Get and display star owner
                starNotary.ownerOf(token, function (error, result) {
                    if (!error) {
                        document.getElementById('star-owner').innerText = result == owner ? 'You' : result
                    } else { 
                        console.log(error);
                        setMessage('lookup', error, 'red')
                    }
                })

                starNotary.starsForSale(token, function(error, result) {
                    if (!error) {
                        document.getElementById('star-price').innerText = (result == 0 ? 'Not for sale' : web3.fromWei(result, 'ether') + 'ETH')
                    }
                })
              })
            }

            function setMessage(divId, message, color) {
              let div = document.getElementById(`message-${divId}`)
              div.innerText = message ? message + '' : ''
              div.className = `row ${color}`
            }
        </script>
    </body>
</html>